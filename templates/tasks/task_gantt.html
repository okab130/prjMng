{% extends 'base.html' %}

{% block title %}ガントチャート{% endblock %}
{% block page_title %}ガントチャート{% endblock %}

{% block page_actions %}
<div class="btn-group">
    <a href="{% url 'tasks:task_list' %}" class="btn btn-secondary">
        <i class="bi bi-list-task"></i> タスク一覧
    </a>
    <a href="{% url 'tasks:task_calendar' %}" class="btn btn-info">
        <i class="bi bi-calendar"></i> カレンダー
    </a>
</div>
{% endblock %}

{% block content %}
<!-- フィルター -->
<div class="card mb-3">
    <div class="card-body">
        <form method="get" class="row g-3" id="filterForm">
            <div class="col-md-4">
                <label class="form-label">プロジェクト</label>
                <select name="project" class="form-select" onchange="this.form.submit()">
                    <option value="">すべて</option>
                    {% for project in projects %}
                    <option value="{{ project.id }}" {% if selected_project == project.id|stringformat:"s" %}selected{% endif %}>
                        {{ project.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">ステータス</label>
                <select name="status" class="form-select" onchange="this.form.submit()">
                    <option value="">すべて</option>
                    <option value="NOT_STARTED" {% if selected_status == "NOT_STARTED" %}selected{% endif %}>未着手</option>
                    <option value="IN_PROGRESS" {% if selected_status == "IN_PROGRESS" %}selected{% endif %}>進行中</option>
                    <option value="COMPLETED" {% if selected_status == "COMPLETED" %}selected{% endif %}>完了</option>
                    <option value="ON_HOLD" {% if selected_status == "ON_HOLD" %}selected{% endif %}>保留</option>
                    <option value="CANCELLED" {% if selected_status == "CANCELLED" %}selected{% endif %}>キャンセル</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">表示期間</label>
                <select name="scale" class="form-select" id="scaleSelect" onchange="this.form.submit()">
                    <option value="day" {% if scale == "day" %}selected{% endif %}>日</option>
                    <option value="week" {% if scale == "week" %}selected{% endif %}>週</option>
                    <option value="month" {% if scale == "month" %}selected{% endif %}>月</option>
                </select>
            </div>
        </form>
    </div>
</div>

<!-- ガントチャート -->
<div class="card">
    <div class="card-body">
        {% if tasks_count > 0 %}
        <div class="gantt_container">
            <div id="gantt_here"></div>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> 表示可能なタスクがありません。
            <br>タスクに「開始日」と「期限」を設定してください。
        </div>
        {% endif %}
    </div>
</div>

<!-- 凡例 -->
<div class="card mt-3">
    <div class="card-body">
        <h6><i class="bi bi-info-circle"></i> 凡例</h6>
        <div class="row">
            <div class="col-md-3">
                <span class="badge bg-secondary">■</span> 未着手
            </div>
            <div class="col-md-3">
                <span class="badge bg-primary">■</span> 進行中
            </div>
            <div class="col-md-3">
                <span class="badge bg-success">■</span> 完了
            </div>
            <div class="col-md-3">
                <span class="badge bg-warning text-dark">■</span> 保留
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link href="https://cdn.dhtmlx.com/gantt/8.0.6/dhtmlxgantt.css" rel="stylesheet">
<style>
    #gantt_here {
        width: 100%;
        height: 600px;
    }
    .gantt_container {
        background: white;
        border-radius: 0.25rem;
        padding: 1rem;
        height: 600px;
        width: 100%;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.dhtmlx.com/gantt/8.0.6/dhtmlxgantt.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== Gantt Chart Debug ===');
    console.log('Gantt version:', gantt.version);
    console.log('gantt object:', typeof gantt);
    
    // DOM要素確認
    var container = document.getElementById('gantt_here');
    console.log('Container element:', container);
    console.log('Container exists:', !!container);
    
    // タスクデータ
    var tasksData = {{ tasks_json|safe }};
    console.log('Tasks count:', tasksData.length);
    console.log('Tasks data:', tasksData);
    
    if (tasksData.length === 0) {
        console.warn('No tasks to display');
        return;
    }
    
    if (!container) {
        console.error('gantt_here container not found!');
        return;
    }
    
    // スケール設定
    var scale = "{{ scale|default:'day' }}";
    console.log('Scale from template:', scale);
    
    // 基本設定
    gantt.config.date_format = "%Y-%m-%d";
    gantt.config.readonly = true;
    gantt.config.show_progress = true;
    gantt.config.autosize = "xy";
    gantt.config.row_height = 30;
    
    // スケールに応じた設定
    if (scale === "week") {
        console.log('Setting week scale');
        gantt.config.scales = [
            {unit: "week", step: 1, format: function(date) {
                var weekNum = gantt.date.date_to_str("%W")(date);
                return "Week " + weekNum;
            }},
            {unit: "day", step: 1, format: "%d %M"}
        ];
    } else if (scale === "month") {
        console.log('Setting month scale');
        gantt.config.scales = [
            {unit: "month", step: 1, format: "%F %Y"},
            {unit: "week", step: 1, format: function(date) {
                var weekNum = gantt.date.date_to_str("%W")(date);
                return "Week " + weekNum;
            }}
        ];
    } else {
        console.log('Setting day scale');
        gantt.config.scales = [
            {unit: "day", step: 1, format: "%d %M"}
        ];
    }
    
    console.log('Config scales:', gantt.config.scales);
    
    // カラム設定
    gantt.config.columns = [
        {name: "text", label: "タスク", width: 200, tree: true},
        {name: "start_date", label: "開始日", align: "center", width: 100},
        {name: "duration", label: "日数", align: "center", width: 60},
        {name: "progress", label: "進捗", align: "center", width: 70, template: function(obj) {
            return Math.round(obj.progress * 100) + "%";
        }}
    ];
    
    // ステータスに応じた色分け
    gantt.templates.task_class = function(start, end, task) {
        switch(task.status) {
            case "NOT_STARTED":
                return "gantt-task-not-started";
            case "IN_PROGRESS":
                return "gantt-task-in-progress";
            case "COMPLETED":
                return "gantt-task-completed";
            case "ON_HOLD":
                return "gantt-task-on-hold";
            case "CANCELLED":
                return "gantt-task-cancelled";
            default:
                return "";
        }
    };
    
    try {
        // 既存のガントチャートインスタンスをクリア
        if (window.gantt && gantt.$initialized) {
            console.log('Clearing existing gantt instance');
            gantt.clearAll();
        }
        
        // 初期化
        console.log('Initializing gantt...');
        gantt.init("gantt_here");
        console.log('Gantt initialized successfully');
        
        // データロード
        console.log('Parsing data...');
        gantt.parse({data: tasksData});
        console.log('Data parsed, task count:', gantt.getTaskCount());
        
        // 最終確認：レンダリング後の設定
        setTimeout(function() {
            var scaleHeader = document.querySelector('.gantt_scale_line');
            console.log('Scale header exists:', !!scaleHeader);
            if (scaleHeader) {
                console.log('Scale header HTML:', scaleHeader.innerHTML.substring(0, 200));
            }
            
            var taskRows = document.querySelectorAll('.gantt_task_row');
            console.log('Task rows count:', taskRows.length);
        }, 200);
    } catch (error) {
        console.error('Gantt initialization error:', error);
        console.error('Error stack:', error.stack);
    }
});
</script>
<style>
.gantt-task-not-started .gantt_task_progress {
    background-color: #6c757d !important;
}
.gantt-task-in-progress .gantt_task_progress {
    background-color: #0d6efd !important;
}
.gantt-task-completed .gantt_task_progress {
    background-color: #198754 !important;
}
.gantt-task-on-hold .gantt_task_progress {
    background-color: #ffc107 !important;
}
.gantt-task-cancelled .gantt_task_progress {
    background-color: #dc3545 !important;
}
</style>
{% endblock %}
