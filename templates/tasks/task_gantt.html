{% extends 'base.html' %}

{% block title %}ガントチャート{% endblock %}
{% block page_title %}ガントチャート{% endblock %}

{% block page_actions %}
<div class="btn-group">
    <a href="{% url 'tasks:task_list' %}" class="btn btn-secondary">
        <i class="bi bi-list-task"></i> タスク一覧
    </a>
    <a href="{% url 'tasks:task_calendar' %}" class="btn btn-info">
        <i class="bi bi-calendar"></i> カレンダー
    </a>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css">
<style>
    #gantt_here {
        width: 100%;
        height: 600px;
    }
    .gantt_container {
        background: white;
        border-radius: 0.25rem;
        padding: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- フィルター -->
<div class="card mb-3">
    <div class="card-body">
        <form method="get" class="row g-3" id="filterForm">
            <div class="col-md-4">
                <label class="form-label">プロジェクト</label>
                <select name="project" class="form-select" onchange="this.form.submit()">
                    <option value="">すべて</option>
                    {% for project in projects %}
                    <option value="{{ project.id }}" {% if selected_project == project.id|stringformat:"s" %}selected{% endif %}>
                        {{ project.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">ステータス</label>
                <select name="status" class="form-select" onchange="this.form.submit()">
                    <option value="">すべて</option>
                    <option value="NOT_STARTED" {% if selected_status == "NOT_STARTED" %}selected{% endif %}>未着手</option>
                    <option value="IN_PROGRESS" {% if selected_status == "IN_PROGRESS" %}selected{% endif %}>進行中</option>
                    <option value="COMPLETED" {% if selected_status == "COMPLETED" %}selected{% endif %}>完了</option>
                    <option value="ON_HOLD" {% if selected_status == "ON_HOLD" %}selected{% endif %}>保留</option>
                    <option value="CANCELLED" {% if selected_status == "CANCELLED" %}selected{% endif %}>キャンセル</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">表示期間</label>
                <select name="scale" class="form-select" id="scaleSelect">
                    <option value="day" {% if scale == "day" %}selected{% endif %}>日</option>
                    <option value="week" {% if scale == "week" %}selected{% endif %}>週</option>
                    <option value="month" {% if scale == "month" %}selected{% endif %}>月</option>
                </select>
            </div>
        </form>
    </div>
</div>

<!-- ガントチャート -->
<div class="card">
    <div class="card-body">
        <div class="gantt_container">
            <div id="gantt_here"></div>
        </div>
    </div>
</div>

<!-- 凡例 -->
<div class="card mt-3">
    <div class="card-body">
        <h6><i class="bi bi-info-circle"></i> 凡例</h6>
        <div class="row">
            <div class="col-md-3">
                <span class="badge bg-secondary">■</span> 未着手
            </div>
            <div class="col-md-3">
                <span class="badge bg-primary">■</span> 進行中
            </div>
            <div class="col-md-3">
                <span class="badge bg-success">■</span> 完了
            </div>
            <div class="col-md-3">
                <span class="badge bg-warning text-dark">■</span> 保留
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ガントチャート初期化関数
    function initGantt(scale) {
        // 既存のガントチャートをクリア
        if (gantt.$initialized) {
            gantt.clearAll();
        }
        
        // ガントチャート設定
        gantt.config.date_format = "%Y-%m-%d %H:%i";
        
        // スケール設定
        if (scale === "week") {
            gantt.config.scale_unit = "week";
            gantt.config.date_scale = "Week %W";
            gantt.config.subscales = [
                {unit: "day", step: 1, date: "%d"}
            ];
        } else if (scale === "month") {
            gantt.config.scale_unit = "month";
            gantt.config.date_scale = "%Y年%m月";
            gantt.config.subscales = [
                {unit: "week", step: 1, date: "Week %W"}
            ];
        } else {
            gantt.config.scale_unit = "day";
            gantt.config.date_scale = "%Y-%m-%d";
            gantt.config.subscales = [];
        }
        
        gantt.config.columns = [
            {name: "text", label: "タスク", width: 200, tree: true},
            {name: "start_date", label: "開始日", align: "center", width: 80},
            {name: "duration", label: "日数", align: "center", width: 50},
            {name: "progress", label: "進捗", align: "center", width: 60, template: function(obj) {
                return Math.round(obj.progress * 100) + "%";
            }}
        ];
        
        // ステータスに応じた色分け
        gantt.templates.task_class = function(start, end, task) {
            switch(task.status) {
                case "NOT_STARTED":
                    return "gantt-task-not-started";
                case "IN_PROGRESS":
                    return "gantt-task-in-progress";
                case "COMPLETED":
                    return "gantt-task-completed";
                case "ON_HOLD":
                    return "gantt-task-on-hold";
                case "CANCELLED":
                    return "gantt-task-cancelled";
                default:
                    return "";
            }
        };
        
        // 読み取り専用設定
        gantt.config.readonly = true;
        
        // 初期化
        gantt.init("gantt_here");
        
        // データロード
        var tasks = {
            data: {{ tasks_json|safe }}
        };
        gantt.parse(tasks);
    }
    
    // 初期表示
    var currentScale = "{{ scale|default:'day' }}";
    initGantt(currentScale);
    
    // スケール変更イベント
    document.getElementById('scaleSelect').addEventListener('change', function() {
        var newScale = this.value;
        initGantt(newScale);
        
        // URLパラメータを更新（ページリロードなし）
        var url = new URL(window.location);
        url.searchParams.set('scale', newScale);
        window.history.pushState({}, '', url);
    });
});
</script>
<style>
.gantt-task-not-started .gantt_task_progress {
    background-color: #6c757d !important;
}
.gantt-task-in-progress .gantt_task_progress {
    background-color: #0d6efd !important;
}
.gantt-task-completed .gantt_task_progress {
    background-color: #198754 !important;
}
.gantt-task-on-hold .gantt_task_progress {
    background-color: #ffc107 !important;
}
.gantt-task-cancelled .gantt_task_progress {
    background-color: #dc3545 !important;
}
</style>
{% endblock %}
